<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discovery Parks - Weather Watcher</title>
  <style>
    :root{
      /* Light mode palette */
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#5c677a;
      --text:#111827;
      --line:#d7dde7;
      --danger:#d92d20;
      --dangerFlashBg: rgba(217,45,32,.18);
      --dangerFlashShadow: rgba(217,45,32,.35);
      --warning:#d97706;
      --ok:#0f766e;
      --wx:#2563eb;
      --wxBg: rgba(37,99,235,.12);
      --wxBorder: rgba(37,99,235,.35);
      --chip:#f0f3f9;
    }

    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:#111827;
      --muted:#9aa4b2;
      --text:#f3f4f6;
      --line:#243047;
      --danger:#f97066;
      --dangerFlashBg: rgba(249,112,102,.22);
      --dangerFlashShadow: rgba(249,112,102,.40);
      --warning:#fbbf24;
      --ok:#2dd4bf;
      --wx:#60a5fa;
      --wxBg: rgba(96,165,250,.18);
      --wxBorder: rgba(96,165,250,.4);
      --chip:#0f172a;
      color-scheme:dark;
    }

    *{box-sizing:border-box}
    html{height:100%; background:var(--bg); color-scheme:light;}
    body{min-height:100vh; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:transparent; color:var(--text);}

    /* Bulletproof full-viewport background (Canvas/iframe safe) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bg);
      z-index:-1;
    }

    header{padding:18px 18px 10px; border-bottom:1px solid var(--line);}
    .wrap{padding:14px 18px 22px; max-width:100%; width:100%; margin:0 auto;}

    .title-row{display:flex; align-items:flex-start; gap:14px;}
    .title-logo{height:44px; width:auto; display:block;}
    .title-text{display:flex; flex-direction:column; gap:2px;}
    h1{margin:0;font-size:20px; font-weight:800; letter-spacing:-0.2px; line-height:1.05}
    h2{margin:0;font-size:16px; font-weight:750; letter-spacing:-0.1px; line-height:1.1; color:var(--muted)}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 14px; justify-content:space-between;}
    .controls-left{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .controls-right{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .filter-summary{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:4px 0 12px;}
    .filter-chip{background:var(--chip); border:1px dashed var(--line); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted)}
    .filter-chip b{color:var(--text); font-weight:700}

    select,input,button{background:var(--card); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:13px;}
    input{min-width:220px;}
    button{cursor:pointer; font-weight:600;}
    button:hover{border-color:#8aa4d6;}

    .small{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .right{white-space:nowrap}
    .nowrap{white-space:nowrap}

    .stats{display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 14px; align-items:center}
    .chip{background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:7px 10px; font-size:12px; color:var(--muted)}
    .chip b{color:var(--text)}

    /* Toggle chips */
    .toggle{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:var(--card); border:1px solid var(--line); border-radius:999px; cursor:pointer; font-size:12px; color:var(--muted); user-select:none}
    .toggle input{display:none}
    .toggle .dot{width:16px; height:16px; border-radius:999px; background:var(--line); position:relative}
    .toggle .dot::after{content:''; position:absolute; inset:3px; border-radius:999px; background:transparent}
    .toggle .toggle-icon{width:14px; height:14px; display:block;}

    .toggle.warn input:checked + .dot{background:var(--warning)}
    .toggle.warn input:checked + .dot::after{background:#fff}
    .toggle.warn.active{border-color:rgba(217,119,6,.55); color:var(--warning)}

    .toggle.danger input:checked + .dot{background:var(--danger)}
    .toggle.danger input:checked + .dot::after{background:#fff}
    .toggle.danger.active{border-color:rgba(217,45,32,.55); color:var(--danger)}

    .toggle.wx input:checked + .dot{background:var(--danger)}
    .toggle.wx input:checked + .dot::after{background:#fff}
    .toggle.wx.active{border-color:rgba(217,45,32,.55); color:var(--danger)}

    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; overflow-x:auto; overflow-y:hidden;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); font-size:13px; vertical-align:top}
    th{color:var(--muted); text-align:left; font-weight:600;}
    tr:last-child td{border-bottom:none;}
    .table-disclaimer{padding:10px 12px; border-top:1px solid var(--line);}

    .empty-cell{text-align:center;}
    .empty-state{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:28px 12px; min-height:140px; color:var(--muted);}
    .empty-state svg{width:28px; height:28px; stroke:currentColor;}
    .empty-state .empty-title{font-weight:700; color:var(--text);}

    .loading-state{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding:28px 12px; min-height:140px; color:var(--muted);}
    .loading-state .loading-title{font-weight:700; color:var(--text);}
    .spinner{width:28px; height:28px; border:3px solid var(--line); border-top-color:var(--text); border-radius:50%; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    @media (prefers-reduced-motion: reduce){
      .spinner{animation:none;}
    }

    /* Sortable headers */
    th.sortable{cursor:pointer; user-select:none}
    th.sortable:hover{background:rgba(138,164,214,.15)}
    .sort-ind{display:inline-block; margin-left:6px; font-size:11px; color:var(--muted)}

    /* Keep park name + badge on one line */
    .row-top{display:block;}
    .park-name{display:flex; align-items:center; gap:8px; min-width:0;}
    .park-name b{flex:0 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .badge{display:inline-flex; gap:6px; align-items:center; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); white-space:nowrap; flex:0 0 auto}
    .badge.warning{border-color:rgba(217,119,6,.55); color:var(--warning)}
    .badge.danger{border-color:rgba(217,45,32,.55); color:var(--danger)}
    .weather-warning-btn{display:inline-flex; align-items:center; gap:6px; border-radius:999px; border:1px solid rgba(217,45,32,.55); background:var(--dangerFlashBg); color:var(--danger); padding:3px 8px; font-size:11px; font-weight:700; cursor:pointer; flex:0 0 auto}
    .weather-warning-btn:hover{border-color:rgba(217,45,32,.85);}
    .weather-warning-btn:focus-visible{outline:3px solid rgba(138,164,214,.35); outline-offset:2px;}
    .weather-warning-btn svg{width:14px; height:14px; display:block;}
    .weather-warning-btn.wx-alert{
      animation: wxAlertPulse 1.1s ease-in-out infinite;
      box-shadow:0 0 0 1px var(--danger);
    }
    @keyframes wxAlertPulse{
      0%,100%{ box-shadow:0 0 0 1px var(--danger); }
      50%{ box-shadow:0 0 0 1px var(--danger), 0 0 0 5px var(--dangerFlashShadow); }
    }
    html[data-refreshing="1"] .weather-warning-btn.wx-alert{
      animation:none !important;
      box-shadow:0 0 0 1px var(--danger);
    }
    @media (prefers-reduced-motion: reduce){
      .weather-warning-btn.wx-alert{animation:none; box-shadow:0 0 0 1px var(--danger);}
    }
    .weather-warning-count{font-weight:700; font-size:11px;}
    .badge[data-tooltip]{position:relative; cursor:help;}
    .badge[data-tooltip]::after{
      content: attr(data-tooltip);
      position:absolute;
      left:0;
      top:calc(100% + 8px);
      background:var(--card);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      line-height:1.35;
      white-space:normal;
      width:max-content;
      max-width:320px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity .15s ease, transform .15s ease;
      z-index:20;
      text-align:left;
    }
    .badge[data-tooltip]::before{
      content:"";
      position:absolute;
      left:12px;
      top:100%;
      border-width:0 6px 6px 6px;
      border-style:solid;
      border-color:transparent transparent var(--card) transparent;
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity .15s ease, transform .15s ease;
      z-index:19;
    }
    .badge[data-tooltip]:hover::after,
    .badge[data-tooltip]:focus-visible::after,
    .badge[data-tooltip]:hover::before,
    .badge[data-tooltip]:focus-visible::before{
      opacity:1;
      transform:translateY(0);
    }

    /* Cell hover tooltip (reuse badge tooltip style) */
    .cell-tooltip[data-tooltip]{
      position:relative;
      cursor:help;
      display:inline-flex;
      align-items:baseline;
      z-index:200;
    }
    .cell-tooltip[data-tooltip]::after{
      content: attr(data-tooltip);
      position:absolute;
      left:0;
      top:calc(100% + 8px);
      background:var(--card);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      font-weight:400;
      line-height:1.35;
      white-space:normal;
      width:max-content;
      max-width:320px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity .15s ease, transform .15s ease;
      z-index:300;
      text-align:left;
    }
    .cell-tooltip[data-tooltip]:hover::after,
    .cell-tooltip[data-tooltip]:focus-visible::after{
      opacity:1;
      transform:translateY(0);
    }

    .hour-head,.hour-cell{min-width:64px;}
    .current-col{min-width:88px;}
    .updated-col{min-width:88px;}

    td.hour-cell,
    td.current-col{
      position:relative;
    }
    td.hour-cell:hover,
    td.hour-cell:focus-within,
    td.current-col:hover,
    td.current-col:focus-within{
      z-index:5;
    }

    .dangerCell{color:var(--danger); font-weight:800;}
    .warningCell{color:var(--warning); font-weight:800;}
    .okCell{color:var(--ok); font-weight:700;}

    .dangerFlash{
      position:relative;
      isolation:isolate;
    }
    .dangerFlash::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:var(--dangerFlashBg);
      opacity:0;
      z-index:0;
      animation: dangerFillFlash 1s ease-in-out infinite;
    }

    @keyframes dangerFillFlash{
      0%, 100%{ opacity:0; }
      50%{ opacity:1; }
    }

    /* Don’t animate during refresh/loading; start after render completes */
    html[data-refreshing="1"] .dangerFlash::before{
      animation:none !important;
      opacity:0 !important;
    }
    @media (prefers-reduced-motion: reduce){
      .dangerFlash::before{animation:none; opacity:1;}
    }

    /* Info button + modal */
    .icon-btn{display:inline-flex; align-items:center; justify-content:center; background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; font-size:14px; font-weight:600; cursor:pointer; color:var(--text)}
    .icon-btn:hover{border-color:#8aa4d6;}

    .theme-toggle{position:relative; display:inline-flex; align-items:center; justify-content:center; padding:10px; background:var(--card); border:1px solid var(--line); border-radius:10px; cursor:pointer; color:var(--text); user-select:none}
    .theme-toggle:hover{border-color:#8aa4d6;}
    .theme-toggle input{position:absolute; opacity:0; width:1px; height:1px; margin:0; padding:0; border:0; min-width:0;}
    .theme-toggle:focus-within{box-shadow:0 0 0 3px rgba(138,164,214,.35);}
    .theme-toggle .theme-icon{display:inline-flex; align-items:center; justify-content:center;}
    .theme-toggle .theme-icon svg{width:18px; height:18px; display:block;}
    .theme-toggle .theme-icon .icon-sun{display:none;}
    .theme-toggle input:checked ~ .theme-icon .icon-sun{display:block;}
    .theme-toggle input:checked ~ .theme-icon .icon-moon{display:none;}

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; z-index:9999;}
    .modal.open{display:flex;}
    .modal-backdrop{position:absolute; inset:0; background:rgba(17,24,39,.38);}
    .modal-card{position:relative; width:min(720px, 100%); max-height:calc(100vh - 36px); background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.18); overflow:hidden; display:flex; flex-direction:column;}
    .modal-card.modal-wide{width:min(820px, 100%);}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
    .modal-title{margin:0; font-size:14px; font-weight:800;}
    .modal-close{border-radius:10px; padding:8px 10px;}
    .modal-body{padding:14px 16px; color:var(--text); overflow:auto;}
    .modal-body p{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.45}
    .modal-body ul{margin:8px 0 0 18px; padding:0; color:var(--muted); font-size:13px; line-height:1.45}
    .modal-body li{margin:6px 0}

    .warning-list{display:flex; flex-direction:column; gap:12px; margin-top:10px;}
    .warning-card{background:var(--chip); border:1px solid var(--line); border-radius:14px; padding:12px;}
    .warning-card-head{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .warning-card-title{font-size:14px; font-weight:800; margin:0;}
    .warning-card-area{font-size:12px; color:var(--muted); margin-top:4px;}
    .warning-chip-row{display:flex; flex-wrap:wrap; gap:6px;}
    .warning-chip{display:inline-flex; align-items:center; border-radius:999px; padding:3px 8px; font-size:11px; border:1px solid var(--line); color:var(--muted); text-transform:capitalize;}
    .warning-chip.type{border-color:var(--wxBorder); color:var(--wx); background:var(--wxBg);}
    .warning-chip.group-major{border-color:rgba(217,45,32,.4); color:var(--danger);}
    .warning-chip.group-moderate{border-color:rgba(217,119,6,.4); color:var(--warning);}
    .warning-chip.group-minor{border-color:rgba(15,118,110,.35); color:var(--ok);}
    .warning-meta{display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:var(--muted); margin-top:8px;}
    .warning-details{margin-top:10px; border-top:1px solid var(--line); padding-top:8px;}
    .warning-details summary{cursor:pointer; color:var(--wx); font-weight:700; font-size:12px; list-style:none; display:flex; align-items:center; gap:6px;}
    .warning-details summary::-webkit-details-marker{display:none;}
    .warning-details summary::before{content:"+"; font-weight:800;}
    .warning-details[open] summary::before{content:"-";}
    .warning-message{margin-top:10px; font-size:13px; line-height:1.45; color:var(--text);}
    .warning-message h1,.warning-message h2,.warning-message h3,.warning-message h4{margin:8px 0 6px; font-size:13px; font-weight:800;}
    .warning-message p{margin:6px 0; color:var(--text);}
    .warning-message ul,.warning-message ol{margin:6px 0 6px 18px; color:var(--text);}
    .warning-message li{margin:6px 0;}
    .warning-message img{max-width:100%; height:auto; border-radius:10px; border:1px solid var(--line);}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title-row">
        <img class="title-logo" src="https://careers.gdaygroup.com.au/files/images/Logos/_800x600_fit_center-center_none/Discovery-Parks-Full-Colour-Portrait.png" alt="Discovery Parks logo" />
        <div class="title-text">
          <h1>Discovery Parks</h1>
          <h2>Weather Watcher</h2>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="controls-left">
        <label class="small">State</label>
        <select id="stateFilter">
          <option value="ALL">All</option>
          <option value="ACT">ACT</option>
          <option value="NSW">NSW</option>
          <option value="NT">NT</option>
          <option value="QLD">QLD</option>
          <option value="SA" selected>SA</option>
          <option value="TAS">TAS</option>
          <option value="VIC">VIC</option>
          <option value="WA">WA</option>
        </select>

        <label class="small">Region</label>
        <select id="regionFilter">
          <option value="ALL">All</option>
          <option value="RW">Rhys</option>
          <option value="AL">Andrew</option>
          <option value="PF">Perry</option>
          <option value="SG">Sean</option>
          <option value="TC">Tom</option>
          <option value="JD">Jeff</option>
          <option value="SL">Scott</option>
          <option value="JL">James</option>
          <option value="WS">Workstay</option>
          <option value="RH">Hospitality</option>
        </select>

        <label class="small">Wind</label>
        <select id="severityFilter">
          <option value="all">All</option>
          <option value="warning">High</option>
          <option value="danger">Very high</option>
        </select>

        <label class="small">Search</label>
        <input id="textFilter" placeholder="Filter by park name…" />

        <label class="toggle wx" title="Filter to parks with active weather alerts">
          <input id="showWxWarnings" type="checkbox" />
          <span class="dot"></span>
          Alerts only
        </label>
        <label class="toggle warn" title="Toggle heatwave warnings">
          <input id="showHeatwaveWarnings" type="checkbox" checked />
          <span class="dot"></span>
          Heatwave
        </label>
      </div>

      <div class="controls-right">
        <span id="status" class="small"></span>
        <button id="resetFiltersBtn" type="button">Reset filters</button>
        <button id="refreshBtn" type="button">↻ Refresh</button>
        <button id="infoBtn" class="icon-btn" type="button" aria-haspopup="dialog" aria-controls="infoModal" title="Information" aria-label="Information">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        </button>
        <label class="theme-toggle" title="Toggle dark mode">
          <input id="darkModeToggle" type="checkbox" aria-label="Toggle dark mode" />
          <span class="theme-icon" aria-hidden="true">
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
            </svg>
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
            </svg>
          </span>
        </label>
      </div>
    </div>

    <div class="filter-summary" id="filterSummary"></div>

    <div class="stats" id="stats"></div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-key="name">Park Name <span class="sort-ind" data-ind="name"></span></th>
            <th class="sortable right current-col" data-key="gustKmh">Current <span class="sort-ind" data-ind="gustKmh"></span></th>
            <th class="right hour-head" data-hour-idx="0"></th>
            <th class="right hour-head" data-hour-idx="1"></th>
            <th class="right hour-head" data-hour-idx="2"></th>
            <th class="right hour-head" data-hour-idx="3"></th>
            <th class="right hour-head" data-hour-idx="4"></th>
            <th class="right hour-head" data-hour-idx="5"></th>
            <th class="right hour-head" data-hour-idx="6"></th>
            <th class="right hour-head" data-hour-idx="7"></th>
            <th class="right hour-head" data-hour-idx="8"></th>
            <th class="right hour-head" data-hour-idx="9"></th>
            <th class="right hour-head" data-hour-idx="10"></th>
            <th class="right hour-head" data-hour-idx="11"></th>
            <th class="right updated-col">Updated</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="table-disclaimer small muted">
        Proof of concept only. Do not rely on this data for operational decisions.
      </div>
    </div>
  </div>

  <!-- Info modal (contains the hidden "Uses BOM..." + Notes content) -->
  <div id="infoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="infoTitle">About Weather Watcher</div>
        <button id="infoClose" class="icon-btn modal-close" type="button">Close</button>
      </div>
      <div class="modal-body">
        <p>
          Uses Bureau of Meteorology (BOM) data (<span class="nowrap">api.weather.bom.gov.au</span>). Gusts are in km/h.
          <span style="color:var(--warning); font-weight:800">High</span> <span id="warningValue">51</span> and above;
          <span style="color:var(--danger); font-weight:800">Very high</span> <span id="dangerValue">63</span> and above.
        </p>
        <ul>
          <li><b>Current</b> is the latest observed gust.</li>
          <li><b>Hourly columns</b> show the next 12 hours starting from the next full hour, using BOM’s hourly gust forecasts (— when unavailable).</li>
          <li>Some parks may show <b>No BOM match</b> if the location search doesn’t find a good hit. Fix by tweaking that park’s <b>searchTerm</b> in the code.</li>
          <li>If BOM temporarily blocks requests, wait a minute and refresh. The loader is deliberately throttled.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Weather alert modal -->
  <div id="warningModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="warningTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card modal-wide">
      <div class="modal-head">
        <div class="modal-title" id="warningTitle">Weather alerts</div>
        <button id="warningClose" class="icon-btn modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" id="warningBody"></div>
    </div>
  </div>

<script>
  // IMPORTANT: Canvas blocks direct calls to BOM. This app uses your Cloudflare Worker.
  const PROXY_BASE = "https://bom-proxy.mcardlej.workers.dev";

  // BOM endpoint (official)
  const BOM_BASE = "https://api.weather.bom.gov.au/v1";

  // ===== Config =====
  // Thresholds are km/h. Change these two constants and the whole app updates.
  const WARNING_KMH = 51;
  const DANGER_KMH  = 63;
  const WARNING_TOOLTIP = 'Trees 13m or greater: Advise all park occupants to limit time spent in fall zones with no protection factors';
  const DANGER_TOOLTIP = 'Trees 6-12m: Advise all park occupants to limit time spent in fall zones with no protection factors. Trees 13m or greater: Create exclusion zone of tree height +50% for fall zones with no protection factors';
  const IMPORTANT_WARNING_GROUPS = new Set(['major', 'moderate']);
  const IMPORTANT_WARNING_LABEL = 'major and moderate alerts only (cancellations hidden)';
  const STATE_NAMES = {
    NSW: 'new south wales',
    ACT: 'australian capital territory',
    VIC: 'victoria',
    TAS: 'tasmania',
    QLD: 'queensland',
    SA: 'south australia',
    NT: 'northern territory',
    WA: 'western australia',
  };
  // ==================

  // --- Park list
  const PARKS = [
    // NSW
    { name: "Ballina", state: "NSW", searchTerm: "Ballina", rom: "SG" },
    { name: "Burrill Lake, Ulladulla", state: "NSW", searchTerm: "Ulladulla", rom: "PF" },
    { name: "Byron Bay", state: "NSW", searchTerm: "Byron Bay", rom: "SG" },
    { name: "Casino", state: "NSW", searchTerm: "Casino", rom: "SG" },
    { name: "Dubbo", state: "NSW", searchTerm: "Dubbo", rom: "RW" },
    { name: "Eden", state: "NSW", searchTerm: "Eden", rom: "PF" },
    { name: "Emerald Beach", state: "NSW", searchTerm: "Emerald Beach", rom: "RW" },
    { name: "Forster", state: "NSW", searchTerm: "Forster", rom: "RW" },
    { name: "Gerroa", state: "NSW", searchTerm: "Gerroa", rom: "PF" },
    { name: "Harrington Beach", state: "NSW", searchTerm: "Harrington", rom: "RW" },
    { name: "Horseshoe Lagoon", state: "NSW", searchTerm: "Horseshoe Lagoon", rom: "JD" },
    { name: "Jindabyne", state: "NSW", searchTerm: "Jindabyne", rom: "JD" },
    { name: "Lake Hume, NSW", state: "NSW", searchTerm: "Lake Hume", rom: "JD" },
    // "Sydney" often maps to Observatory Hill, whose observations frequently report gust as null.
    // "Mascot" maps to Sydney Airport, which reliably provides gust observations + hourly gust forecasts.
    { name: "Lane Cove", state: "NSW", searchTerm: "Mascot", rom: "RW" },
    { name: "Maidens Inn, Moama", state: "NSW", searchTerm: "Moama", rom: "JD" },
    { name: "Moama Waters", state: "NSW", searchTerm: "Moama", rom: "JD" },
    { name: "Moama West", state: "NSW", searchTerm: "Moama", rom: "JD" },
    { name: "Narooma Beach", state: "NSW", searchTerm: "Narooma", rom: "PF" },
    { name: "Pambula Beach", state: "NSW", searchTerm: "Pambula", rom: "PF" },

    // ACT
    { name: "Canberra", state: "ACT", searchTerm: "Canberra", rom: "RW" },

    // NT
    { name: "Alice Springs", state: "NT", searchTerm: "Alice Springs", rom: "RH" },
    { name: "Bradshaw", state: "NT", searchTerm: "Bradshaw", rom: "WS" },
    { name: "Darwin", state: "NT", searchTerm: "Darwin", rom: "RH" },
    { name: "Delamere", state: "NT", searchTerm: "Delamere", rom: "WS" },
    { name: "Glen Helen", state: "NT", searchTerm: "Alice Springs", rom: "RH" },
    { name: "Katherine", state: "NT", searchTerm: "Katherine", rom: "RH" },
    { name: "Kings Canyon", state: "NT", searchTerm: "Yulara", rom: "RH" },
    { name: "Lansdowne", state: "NT", searchTerm: "Lansdowne", rom: "WS" },

    
    // QLD
    { name: "Airlie Beach", state: "QLD", searchTerm: "Airlie Beach", rom: "SG" },
    { name: "Argylla", state: "QLD", searchTerm: "Mount Isa", rom: "WS" },
    { name: "Ayr", state: "QLD", searchTerm: "Ayr", rom: "WS" },
    { name: "Bargara", state: "QLD", searchTerm: "Bargara", rom: "SG" },
    { name: "Biloela", state: "QLD", searchTerm: "Biloela", rom: "WS" },
    { name: "Blackwater", state: "QLD", searchTerm: "Blackwater", rom: "WS" },
    { name: "Cloncurry", state: "QLD", searchTerm: "Cloncurry", rom: "WS" },
    { name: "Coolwaters, Yeppoon", state: "QLD", searchTerm: "Yeppoon", rom: "SG" },
    { name: "Emerald", state: "QLD", searchTerm: "Emerald", rom: "WS" },
    { name: "Fraser Street, Hervey Bay", state: "QLD", searchTerm: "Hervey Bay", rom: "SG" },
    { name: "Lake Tinaroo", state: "QLD", searchTerm: "Tinaroo", rom: "SG" },
    { name: "Mackay", state: "QLD", searchTerm: "Mackay", rom: "SG" },
    { name: "Mount Isa", state: "QLD", searchTerm: "Mount Isa", rom: "WS" },
    { name: "Mount Surprise", state: "QLD", searchTerm: "Mount Surprise", rom: "RH" },
    { name: "Rockhampton", state: "QLD", searchTerm: "Rockhampton", rom: "SG" },
    { name: "Tannum Sands", state: "QLD", searchTerm: "Tannum Sands", rom: "SG" },
    { name: "Townsville", state: "QLD", searchTerm: "Townsville", rom: "SG" },
    { name: "Undara", state: "QLD", searchTerm: "Mount Surprise", rom: "RH" },

    // SA
    { name: "Adelaide Beachfront", state: "SA", searchTerm: "Adelaide", rom: "SL" },
    { name: "Barossa Valley", state: "SA", searchTerm: "Tanunda", rom: "SL" },
    { name: "Ardrossan", state: "SA", searchTerm: "Ardrossan", rom: "SL" },
    { name: "Clare", state: "SA", searchTerm: "Clare", rom: "SL" },
    { name: "Coffin Bay", state: "SA", searchTerm: "Coffin Bay", rom: "SL" },
    { name: "Goolwa", state: "SA", searchTerm: "Goolwa", rom: "SL" },
    { name: "Hahndorf", state: "SA", searchTerm: "Hahndorf", rom: "SL" },
    { name: "Kangaroo Island", state: "SA", searchTerm: "Kingscote", rom: "SL" },
    { name: "Lake Bonney", state: "SA", searchTerm: "Barmera", rom: "JL" },
    { name: "McCracken Resort", state: "SA", searchTerm: "Victor Harbor", rom: "RH" },
    { name: "Port Augusta", state: "SA", searchTerm: "Port Augusta", rom: "SL" },
    { name: "Renmark Riverfront", state: "SA", searchTerm: "Renmark", rom: "JL" },
    { name: "Robe", state: "SA", searchTerm: "Robe", rom: "JL" },
    { name: "Roxby Downs", state: "SA", searchTerm: "Roxby Downs", rom: "WS" },
    { name: "Streaky Bay Foreshore", state: "SA", searchTerm: "Streaky Bay", rom: "SL" },
    { name: "Whyalla Foreshore", state: "SA", searchTerm: "Whyalla", rom: "SL" },
    { name: "Wilpena Pound", state: "SA", searchTerm: "Hawker", rom: "RH" },

    // TAS
    { name: "Cradle Mountain", state: "TAS", searchTerm: "Cradle Mountain", rom: "RH" },
    { name: "Cradle Mountain Village", state: "TAS", searchTerm: "Cradle Mountain", rom: "RH" },
    { name: "Devonport", state: "TAS", searchTerm: "Devonport", rom: "AL" },
    { name: "Hadspen", state: "TAS", searchTerm: "Hadspen", rom: "AL" },
    { name: "Hobart", state: "TAS", searchTerm: "Hobart", rom: "AL" },
    { name: "Mornington Hobart", state: "TAS", searchTerm: "Hobart", rom: "AL" },

    // VIC
    { name: "Bright", state: "VIC", searchTerm: "Bright", rom: "JL" },
    { name: "Echuca", state: "VIC", searchTerm: "Echuca", rom: "JD" },
    { name: "Geelong", state: "VIC", searchTerm: "Geelong", rom: "JL" },
    { name: "Lake Hume, VIC", state: "VIC", searchTerm: "Lake Hume", rom: "JD" },
    { name: "Melbourne", state: "VIC", searchTerm: "Melbourne", rom: "JL" },
    { name: "Mildura, Buronga Riverside", state: "VIC", searchTerm: "Mildura", rom: "JL" },
    { name: "Mount Buffalo", state: "VIC", searchTerm: "Mount Buffalo", rom: "JL" },
    { name: "Nagambie Lakes", state: "VIC", searchTerm: "Nagambie", rom: "JD" },
    { name: "Warrnambool", state: "VIC", searchTerm: "Warrnambool", rom: "JL" },

    // WA
    { name: "Broome", state: "WA", searchTerm: "Broome", rom: "RH" },
    { name: "Boulder", state: "WA", searchTerm: "Boulder", rom: "WS" },
    { name: "Bunbury Foreshore", state: "WA", searchTerm: "Bunbury", rom: "TC" },
    { name: "Bunbury Village", state: "WA", searchTerm: "Bunbury", rom: "WS" },
    { name: "Busselton", state: "WA", searchTerm: "Busselton", rom: "TC" },
    { name: "Carnarvon", state: "WA", searchTerm: "Carnarvon", rom: "TC" },
    { name: "Coogee Beach", state: "WA", searchTerm: "Coogee", rom: "TC" },
    { name: "Kalgoorlie", state: "WA", searchTerm: "Kalgoorlie", rom: "WS" },
    { name: "Lake Kununurra", state: "WA", searchTerm: "Kununurra", rom: "RH" },
    { name: "Lake Argyle", state: "WA", searchTerm: "Lake Argyle", rom: "RH" },
    { name: "Margaret River", state: "WA", searchTerm: "Margaret River", rom: "TC" },
    { name: "Onslow", state: "WA", searchTerm: "Onslow", rom: "WS" },
    { name: "Perth Airport", state: "WA", searchTerm: "Perth Airport", rom: "TC" },
    { name: "Pilbara, Karratha", state: "WA", searchTerm: "Karratha", rom: "WS" },
    { name: "Port Hedland", state: "WA", searchTerm: "Port Hedland", rom: "WS" },
    { name: "Woodman Point", state: "WA", searchTerm: "Fremantle", rom: "TC" },
    { name: "Rottnest Island", state: "WA", searchTerm: "Rottnest Island", rom: "RH" },
    { name: "Swan Valley", state: "WA", searchTerm: "Herne Hill", rom: "TC" },
    { name: "El Questro", state: "WA", searchTerm: "Kununurra", rom: "RH" }
  ];

  const els = {
    stateFilter: document.getElementById('stateFilter'),
    regionFilter: document.getElementById('regionFilter'),
    textFilter: document.getElementById('textFilter'),
    severityFilter: document.getElementById('severityFilter'),
    showWxWarnings: document.getElementById('showWxWarnings'),
    showHeatwaveWarnings: document.getElementById('showHeatwaveWarnings'),
    refreshBtn: document.getElementById('refreshBtn'),
    resetFiltersBtn: document.getElementById('resetFiltersBtn'),
    status: document.getElementById('status'),
    tbody: document.getElementById('tbody'),
    stats: document.getElementById('stats'),
    filterSummary: document.getElementById('filterSummary'),
    infoBtn: document.getElementById('infoBtn'),
    infoModal: document.getElementById('infoModal'),
    infoClose: document.getElementById('infoClose'),
    warningModal: document.getElementById('warningModal'),
    warningTitle: document.getElementById('warningTitle'),
    warningBody: document.getElementById('warningBody'),
    warningClose: document.getElementById('warningClose'),
    darkModeToggle: document.getElementById('darkModeToggle'),
  };

  const DEFAULT_FILTERS = {
    state: els.stateFilter?.options?.[0]?.value || 'ALL',
    region: els.regionFilter?.options?.[0]?.value || 'ALL',
    text: '',
    severity: 'all',
    alertsOnly: false,
    heatwaveWarnings: true,
  };

  const cache = { locations: new Map() };
  const LOC_CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12h, matches worker /locations cache
  let warningsById = new Map();
  const warningDetailCache = new Map();
  let warningModalToken = 0;
  let allRows = [];
  let isLoading = false;
  let tableState = 'blank';
  const TABLE_COL_COUNT = document.querySelectorAll('thead th').length || 15;

  // Sorting (applies after filters). Updated column is intentionally not sortable.
  let sortKey = null; // null = default (State then Park)
  let sortDir = 'asc';
  const SORT_KEY_ALIASES = {
    windKmh: 'gustKmh',
    f3WindKmh: null,
    t9WindKmh: null,
    f12GustKmh: null,
    state: null,
  };
  const SORT_KEYS = new Set(['name', 'gustKmh']);

  // Filters
  let severityFilter = 'all'; // 'all' | 'warning' | 'danger'
  let showWeatherWarnings = false;
  let heatwaveWarningsEnabled = true;

  let darkModeEnabled = false;

  // --- Persist UI prefs (filters + sort) ---
  // Uses localStorage when available, falls back to cookies.
  const PREF_KEY = 'dp_wind_watcher_prefs_v1';
  const URL_FILTER_KEYS = ['state', 'region', 'wind', 'severity', 'search', 'alerts', 'heatwave'];

  function cookieGet(name){
    const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\\/\+^]/g,'\\$&') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : null;
  }

  function cookieSet(name, value, days=365){
    const expires = new Date(Date.now() + days*864e5).toUTCString();
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
  }

  function safeJsonParse(s){
    try { return JSON.parse(s); } catch { return null; }
  }

  function readPrefs(){
    try {
      const raw = localStorage.getItem(PREF_KEY);
      if (raw) return safeJsonParse(raw) || null;
    } catch {}

    const c = cookieGet(PREF_KEY);
    return c ? (safeJsonParse(c) || null) : null;
  }

  function writePrefs(prefs){
    const raw = JSON.stringify(prefs);
    try { localStorage.setItem(PREF_KEY, raw); return; } catch {}
    cookieSet(PREF_KEY, raw);
  }

  function parseBoolParam(raw){
    if (raw === null || raw === undefined) return null;
    const v = String(raw).trim().toLowerCase();
    if (v === '' || v === '1' || v === 'true' || v === 'yes' || v === 'on') return true;
    if (v === '0' || v === 'false' || v === 'no' || v === 'off') return false;
    return null;
  }

  function normalizeSeverityParam(raw){
    if (raw === null || raw === undefined) return null;
    const v = String(raw).trim().toLowerCase();
    if (!v) return null;
    if (v === 'all') return 'all';
    if (v === 'warning' || v === 'high') return 'warning';
    if (v === 'danger' || v === 'very-high' || v === 'veryhigh' || v === 'very_high') return 'danger';
    return null;
  }

  function selectHasValue(selectEl, value){
    if (!selectEl) return false;
    return Array.from(selectEl.options).some(o => o.value === value);
  }

  function applyUrlFilters(){
    if (typeof window === 'undefined') return;
    const params = new URLSearchParams(window.location.search);
    if (!params || !params.toString()) return;

    const stateRaw = params.get('state');
    if (stateRaw) {
      const stateVal = stateRaw.trim().toUpperCase();
      if (selectHasValue(els.stateFilter, stateVal)) els.stateFilter.value = stateVal;
    }

    const regionRaw = params.get('region');
    if (regionRaw) {
      const regionVal = regionRaw.trim().toUpperCase();
      if (selectHasValue(els.regionFilter, regionVal)) els.regionFilter.value = regionVal;
    }

    const windRaw = params.get('wind') || params.get('severity');
    const windVal = normalizeSeverityParam(windRaw);
    if (windVal) severityFilter = windVal;
    if (els.severityFilter) els.severityFilter.value = severityFilter;

    if (params.has('search')) {
      els.textFilter.value = params.get('search') || '';
    }

    if (params.has('alerts')) {
      const alertsVal = parseBoolParam(params.get('alerts'));
      if (typeof alertsVal === 'boolean') showWeatherWarnings = alertsVal;
    }
    if (params.has('heatwave')) {
      const heatwaveVal = parseBoolParam(params.get('heatwave'));
      if (typeof heatwaveVal === 'boolean') heatwaveWarningsEnabled = heatwaveVal;
    }
    if (els.showWxWarnings) els.showWxWarnings.checked = !!showWeatherWarnings;
    if (els.showHeatwaveWarnings) els.showHeatwaveWarnings.checked = !!heatwaveWarningsEnabled;
    syncWeatherToggle();
    syncHeatwaveToggle();
  }

  function updateUrlFromFilters(){
    if (typeof window === 'undefined' || !window.history || !window.location) return;
    const params = new URLSearchParams(window.location.search);
    URL_FILTER_KEYS.forEach(k => params.delete(k));

    const stateVal = els.stateFilter.value;
    if (stateVal && stateVal !== DEFAULT_FILTERS.state) params.set('state', stateVal);

    const regionVal = els.regionFilter.value;
    if (regionVal && regionVal !== DEFAULT_FILTERS.region) params.set('region', regionVal);

    if (severityFilter && severityFilter !== DEFAULT_FILTERS.severity) {
      params.set('wind', severityFilter);
    }

    const searchVal = els.textFilter.value.trim();
    if (searchVal) params.set('search', searchVal);

    if (showWeatherWarnings) params.set('alerts', '1');
    if (heatwaveWarningsEnabled !== DEFAULT_FILTERS.heatwaveWarnings) {
      params.set('heatwave', heatwaveWarningsEnabled ? '1' : '0');
    }

    const nextQuery = params.toString();
    const nextUrl = `${window.location.pathname}${nextQuery ? `?${nextQuery}` : ''}${window.location.hash || ''}`;
    const currentUrl = `${window.location.pathname}${window.location.search}${window.location.hash || ''}`;
    if (nextUrl !== currentUrl) window.history.replaceState({}, '', nextUrl);
  }

  function currentPrefs(){
    return {
      state: els.stateFilter.value,
      region: els.regionFilter.value,
      text: els.textFilter.value,
      severity: severityFilter,
      showWeatherWarnings: !!showWeatherWarnings,
      heatwaveWarnings: !!heatwaveWarningsEnabled,
      darkMode: !!darkModeEnabled,
      sortKey: sortKey,
      sortDir: sortDir,
    };
  }

  function savePrefs(){
    writePrefs(currentPrefs());
  }

  const savePrefsDebounced = debounce(savePrefs, 250);
  const updateUrlDebounced = debounce(updateUrlFromFilters, 250);
  const renderDebounced = debounce(render, 120);

  function applyPrefs(){
    const p = readPrefs();
    if (!p || typeof p !== 'object') return;

    // State
    if (typeof p.state === 'string') {
      const opt = Array.from(els.stateFilter.options).some(o => o.value === p.state);
      if (opt) els.stateFilter.value = p.state;
    }

    // Region
    if (typeof p.region === 'string') {
      const opt = Array.from(els.regionFilter.options).some(o => o.value === p.region);
      if (opt) els.regionFilter.value = p.region;
    }

    // Text
    if (typeof p.text === 'string') {
      els.textFilter.value = p.text;
    }

    // Filters
    if (typeof p.severity === 'string') {
      const s = p.severity.toLowerCase();
      severityFilter = (s === 'warning' || s === 'danger') ? s : 'all';
    } else {
      const warn = !!p.showWarning;
      const danger = !!p.showDanger;
      if (danger && !warn) severityFilter = 'danger';
      else if (warn) severityFilter = 'warning';
      else severityFilter = 'all';
    }
    if (typeof p.showWeatherWarnings === 'boolean') showWeatherWarnings = p.showWeatherWarnings;
    if (typeof p.heatwaveWarnings === 'boolean') heatwaveWarningsEnabled = p.heatwaveWarnings;
    if (typeof p.darkMode === 'boolean') darkModeEnabled = p.darkMode;

    if (els.severityFilter) els.severityFilter.value = severityFilter;
    if (els.showWxWarnings) els.showWxWarnings.checked = !!showWeatherWarnings;
    if (els.showHeatwaveWarnings) els.showHeatwaveWarnings.checked = !!heatwaveWarningsEnabled;
    syncWeatherToggle();
    syncHeatwaveToggle();

    // Sort
    if (p.sortKey === null) {
      sortKey = null;
    } else if (typeof p.sortKey === 'string') {
      const mapped = Object.prototype.hasOwnProperty.call(SORT_KEY_ALIASES, p.sortKey)
        ? SORT_KEY_ALIASES[p.sortKey]
        : p.sortKey;
      sortKey = SORT_KEYS.has(mapped) ? mapped : null;
    }
    if (p.sortDir === 'asc' || p.sortDir === 'desc') sortDir = p.sortDir;
  }

  function applyTheme(){
    if (darkModeEnabled) document.documentElement.setAttribute('data-theme', 'dark');
    else document.documentElement.removeAttribute('data-theme');
    if (els.darkModeToggle) els.darkModeToggle.checked = !!darkModeEnabled;
  }

  function syncWeatherToggle(){
    if (!els.showWxWarnings) return;
    const label = els.showWxWarnings.closest('.toggle');
    if (label) label.classList.toggle('active', !!showWeatherWarnings);
  }

  function syncHeatwaveToggle(){
    if (!els.showHeatwaveWarnings) return;
    const label = els.showHeatwaveWarnings.closest('.toggle');
    if (label) label.classList.toggle('active', !!heatwaveWarningsEnabled);
  }

  function setStatus(msg){
    els.status.textContent = msg || '';
  }

  function formatKmh(v){
    if (v === null || v === undefined || Number.isNaN(v)) return '—';
    return `${Math.round(v)} km/h`;
  }

  const HOUR_MS = 60 * 60 * 1000;
  let forecastSlots = [];
  let forecastSlotsTz = null;
  let forecastSlotsMode = null; // 'relative' | 'clock'

  function timeZoneForState(state){
    // Use IANA zones so DST is handled correctly.
    // Note: NSW/ACT/VIC/TAS share the same rules; SA is half-hour offset; QLD/NT/WA have no DST.
    switch(String(state || '').toUpperCase()){
      case 'NSW':
      case 'ACT':
      case 'VIC':
      case 'TAS':
        return 'Australia/Sydney';
      case 'QLD':
        return 'Australia/Brisbane';
      case 'SA':
        return 'Australia/Adelaide';
      case 'NT':
        return 'Australia/Darwin';
      case 'WA':
        return 'Australia/Perth';
      default:
        return null;
    }
  }

  function getDisplayTimeZone(){
    // When a specific state is selected, show that state's local time.
    // When ALL is selected, there isn't a single "park timezone" for the shared headers;
    // we use relative headings (+1h..+12h), but still provide a safe fallback timezone.
    const st = els.stateFilter?.value || 'ALL';
    const tz = (st !== 'ALL') ? timeZoneForState(st) : null;
    if (tz) return tz;
    try {
      return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    } catch {
      return 'UTC';
    }
  }

  function getHourHeaderMode(){
    // In ALL mode a single set of clock-times cannot be "local" for every state,
    // so use relative headings that are globally unambiguous.
    return (els.stateFilter?.value === 'ALL') ? 'relative' : 'clock';
  }

  function formatHourLabelMs(ms, timeZone){
    // "10am" / "12pm" / "9:30am" in the desired timezone
    try {
      const parts = new Intl.DateTimeFormat('en-AU', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
        timeZone
      }).formatToParts(new Date(ms));

      const get = (type) => parts.find(p => p.type === type)?.value ?? '';
      const hour = get('hour');
      const minute = get('minute'); // "00" or "30" (etc)
      const dayPeriod = get('dayPeriod'); // "AM"/"PM"

      let out = String(hour || '').trim();
      if (minute && minute !== '00') out += `:${minute}`;
      out += String(dayPeriod || '').trim();

      return out
        .replace(/\s+/g, '')
        .replaceAll('.', '')
        .toLowerCase();
    } catch {
      // Fallback: local time
      const d = new Date(ms);
      const m = d.getMinutes();
      let h = d.getHours();
      const suffix = h >= 12 ? 'pm' : 'am';
      h = h % 12;
      if (h === 0) h = 12;
      if (m && m !== 0) return `${h}:${String(m).padStart(2,'0')}${suffix}`;
      return `${h}${suffix}`;
    }
  }

  function buildForecastSlots(baseMs = Date.now(), timeZone = getDisplayTimeZone(), mode = getHourHeaderMode()){
    // BOM hourly forecast timestamps are UTC (`...Z`) and always align to UTC hour boundaries.
    // Build our slots on UTC hour boundaries to avoid viewer-local DST shifts.
    const startMs = (Math.floor(baseMs / HOUR_MS) * HOUR_MS) + HOUR_MS; // next full UTC hour
    return Array.from({length: 12}, (_, i) => {
      const ms = startMs + i * HOUR_MS;
      const label = (mode === 'relative') ? `+${i+1}h` : formatHourLabelMs(ms, timeZone);
      return { ms, label };
    });
  }

  function ensureForecastSlots(){
    const tz = getDisplayTimeZone();
    const mode = getHourHeaderMode();
    if (!Array.isArray(forecastSlots) || forecastSlots.length !== 12 || forecastSlotsTz !== tz || forecastSlotsMode !== mode) {
      forecastSlots = buildForecastSlots(Date.now(), tz, mode);
      forecastSlotsTz = tz;
      forecastSlotsMode = mode;
    }
    return forecastSlots;
  }

  function levelFor(v){
    if (v === null || v === undefined || Number.isNaN(v)) return 'none';
    if (v >= DANGER_KMH) return 'danger';
    if (v >= WARNING_KMH) return 'warning';
    return 'ok';
  }

  function rowLevel(row){
    // Overall severity is the worst level across gust columns.
    const vals = [row.gustKmh];
    if (row.hourlyGusts && typeof row.hourlyGusts.values === 'function') {
      for (const v of row.hourlyGusts.values()) vals.push(v);
    }

    let sawOk = false;
    let sawWarning = false;

    for (const v of vals){
      const lvl = levelFor(v);
      if (lvl === 'danger') return 'danger';
      if (lvl === 'warning') sawWarning = true;
      if (lvl === 'ok') sawOk = true;
    }

    if (sawWarning) return 'warning';
    if (sawOk) return 'ok';
    return 'none';
  }

  function cellClassFor(v){
    const lvl = levelFor(v);
    if (lvl === 'danger') return 'dangerCell dangerFlash';
    if (lvl === 'warning') return 'warningCell';
    if (lvl === 'ok') return 'okCell';
    return '';
  }

  function setRefreshing(on){
    if (on) document.documentElement.setAttribute('data-refreshing', '1');
    else document.documentElement.removeAttribute('data-refreshing');
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function formatWarningType(type){
    if (!type) return '';
    const t = String(type).replace(/_/g, ' ').toLowerCase();
    return t.replace(/\b\w/g, (m) => m.toUpperCase());
  }

  const HEATWAVE_WARNING_RE = /\bheat\s*wave\b/i;
  const CANCELLATION_WARNING_RE = /\bcancel(?:led|lation)\b/i;

  function isHeatwaveWarning(warn){
    const fields = [
      warn?.type,
      warn?.warning_type,
      warn?.type_description,
      warn?.short_title,
      warn?.title,
      warn?.headline,
    ];
    return fields.some(v => typeof v === 'string' && HEATWAVE_WARNING_RE.test(v));
  }

  function isCancellationWarning(warn){
    const fields = [
      warn?.short_title,
      warn?.title,
      warn?.headline,
      warn?.type_description,
      warn?.warning_type,
      warn?.type,
    ];
    return fields.some(v => typeof v === 'string' && CANCELLATION_WARNING_RE.test(v));
  }

  function filterHeatwaveWarnings(list){
    if (!Array.isArray(list)) return [];
    if (heatwaveWarningsEnabled) return list;
    return list.filter(w => !isHeatwaveWarning(w));
  }

  function warningsForRow(row){
    return filterHeatwaveWarnings(row?.weatherWarnings);
  }

  function formatDateTime(ts, state){
    if (!ts) return '—';
    const d = new Date(ts);
    if (!Number.isFinite(d.getTime())) return '—';
    try {
      const opts = { dateStyle: 'medium', timeStyle: 'short' };
      const tz = timeZoneForState(state);
      if (tz) opts.timeZone = tz;
      return new Intl.DateTimeFormat('en-AU', opts).format(d);
    } catch {
      return d.toLocaleString();
    }
  }

  const SAFE_IMAGE_DATA_RE = /^data:image\/(png|jpe?g|gif|webp);\s*base64,/i;
  const BOM_IMAGE_BASE = 'https://www.bom.gov.au';

  function normalizeImageSrc(raw){
    const value = String(raw || '').trim();
    if (!value) return '';
    if (/^https?:/i.test(value)) return value;
    if (value.startsWith('//')) return `https:${value}`;
    if (SAFE_IMAGE_DATA_RE.test(value)) return value;
    if (value.startsWith('/')) return `${BOM_IMAGE_BASE}${value}`;
    return '';
  }

  function sanitizeWarningHtml(raw){
    const tpl = document.createElement('template');
    tpl.innerHTML = String(raw || '');

    const allowedTags = new Set([
      'p','br','strong','b','em','i','ul','ol','li',
      'h1','h2','h3','h4','h5','h6','table','thead','tbody',
      'tr','th','td','a','img','div','span','small','hr','pre','code'
    ]);

    const allowedAttrs = {
      a: new Set(['href','title']),
      img: new Set(['src','alt','width','height']),
    };

    tpl.content.querySelectorAll('*').forEach(el => {
      const tag = el.tagName.toLowerCase();
      if (!allowedTags.has(tag)) {
        el.replaceWith(document.createTextNode(el.textContent || ''));
        return;
      }

      [...el.attributes].forEach(attr => {
        const name = attr.name.toLowerCase();
        const value = attr.value || '';

        if (name.startsWith('on') || name === 'style') {
          el.removeAttribute(attr.name);
          return;
        }

        const allowSet = allowedAttrs[tag];
        if (allowSet && allowSet.has(name)) {
          if (tag === 'a' && name === 'href' && !/^https?:/i.test(value)) {
            el.removeAttribute(attr.name);
            return;
          }
          if (tag === 'img' && name === 'src') {
            const normalized = normalizeImageSrc(value);
            if (!normalized) {
              el.removeAttribute(attr.name);
              return;
            }
            if (normalized !== value) el.setAttribute('src', normalized);
            return;
          }
          return;
        }

        el.removeAttribute(attr.name);
      });

      if (tag === 'a') {
        el.setAttribute('target', '_blank');
        el.setAttribute('rel', 'noopener');
      }
      if (tag === 'img') {
        el.setAttribute('loading', 'lazy');
        el.setAttribute('referrerpolicy', 'no-referrer');
        if (!el.getAttribute('alt')) el.setAttribute('alt', 'Warning image');
      }
    });

    return tpl.innerHTML;
  }

  function getSortValue(row, key){
    switch(key){
      case 'name': return row.name;
      case 'state': return row.state;
      case 'gustKmh': return row.gustKmh;
      default: return null;
    }
  }

  function sortRows(rows){
    const key = sortKey;
    const dir = sortDir;

    // Default sort: State then Park
    if (!key){
      rows.sort((a,b) => a.state.localeCompare(b.state) || a.name.localeCompare(b.name));
      return rows;
    }

    const isNum = (v) => typeof v === 'number' && Number.isFinite(v);

    rows.sort((a,b) => {
      let av = getSortValue(a, key);
      let bv = getSortValue(b, key);

      // Null/undefined always last
      const aNull = (av === null || av === undefined || Number.isNaN(av));
      const bNull = (bv === null || bv === undefined || Number.isNaN(bv));
      if (aNull && bNull) return 0;
      if (aNull) return 1;
      if (bNull) return -1;

      let c = 0;
      if (isNum(av) && isNum(bv)) c = av - bv;
      else c = String(av).localeCompare(String(bv), 'en', { sensitivity: 'base' });

      // Stable tie-breakers
      if (c === 0) c = a.state.localeCompare(b.state) || a.name.localeCompare(b.name);

      return dir === 'asc' ? c : -c;
    });

    return rows;
  }

  function setSort(key){
    if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
    else { sortKey = key; sortDir = 'asc'; }
    savePrefs();
    render();
  }

  function updateSortIndicators(){
    const inds = document.querySelectorAll('[data-ind]');
    inds.forEach(el => {
      const k = el.getAttribute('data-ind');
      if (!sortKey){
        el.textContent = (k === 'name') ? '·' : '';
        return;
      }
      if (k !== sortKey) { el.textContent = ''; return; }
      el.textContent = (sortDir === 'asc') ? '▲' : '▼';
    });
  }

  function updateHourHeaders(){
    const slots = ensureForecastSlots();
    const heads = document.querySelectorAll('th.hour-head');
    heads.forEach((th, idx) => {
      const slot = slots[idx];
      if (!slot) { th.textContent = ''; return; }
      th.textContent = slot.label;
    });
  }

  function filteredRows(){
    const st = els.stateFilter.value;
    const rg = els.regionFilter.value;
    const q = els.textFilter.value.trim().toLowerCase();

    const rows = allRows
      .map(r => {
        if (r.loaded) r.severity = rowLevel(r);
        return r;
      })
      .filter(r => (st === 'ALL' ? true : r.state === st))
      .filter(r => (rg === 'ALL' ? true : r.rom === rg))
      .filter(r => (q ? r.name.toLowerCase().includes(q) : true))
      .filter(r => {
        if (severityFilter === 'danger') return r.severity === 'danger';
        if (severityFilter === 'warning') return r.severity === 'warning' || r.severity === 'danger';
        return true;
      })
      .filter(r => {
        if (!showWeatherWarnings) return true;
        return warningsForRow(r).length > 0;
      });

    return sortRows(rows);
  }

  function renderStats(rows){
    const total = rows.length;
    const danger = rows.filter(r => r.severity === 'danger').length;
    const warning = rows.filter(r => r.severity === 'warning').length;
    const ok = rows.filter(r => r.loaded && (r.severity === 'ok')).length;
    const missing = rows.filter(r => r.loaded && r.severity === 'none').length;
    const weatherWarn = rows.filter(r => warningsForRow(r).length > 0).length;

    els.stats.innerHTML = [
      `<span class="chip"><b>${total}</b> parks</span>`,
      `<span class="chip"><b>${ok}</b> OK</span>`,
      `<span class="chip"><b>${missing}</b> no gust data</span>`,
      `<span class="chip"><b style="color:var(--warning)">${warning}</b> High &gt;= ${WARNING_KMH}</span>`,
      `<span class="chip"><b style="color:var(--danger)">${danger}</b> Very high &gt;= ${DANGER_KMH}</span>`,
      `<span class="chip"><b style="color:var(--danger)">${weatherWarn}</b> weather alerts</span>`
    ].join('');
  }

  function renderFilterSummary(){
    if (!els.filterSummary) return;
    const parts = [];
    const stateVal = els.stateFilter.value;
    const regionVal = els.regionFilter.value;
    const textVal = els.textFilter.value.trim();
    const regionLabel = els.regionFilter?.options?.[els.regionFilter.selectedIndex]?.text || regionVal;

    if (stateVal !== DEFAULT_FILTERS.state) parts.push({ label: 'State', value: stateVal });
    if (regionVal !== DEFAULT_FILTERS.region) parts.push({ label: 'Region', value: regionLabel });
    if (severityFilter !== DEFAULT_FILTERS.severity) {
      const sevLabel = severityFilter === 'warning'
        ? 'High'
        : 'Very high';
      parts.push({ label: 'Wind', value: sevLabel });
    }

    if (textVal) parts.push({ label: 'Search', value: `"${textVal}"` });

    if (showWeatherWarnings) parts.push({ label: 'Alerts', value: 'Alerts Only' });
    if (heatwaveWarningsEnabled !== DEFAULT_FILTERS.heatwaveWarnings) {
      parts.push({ label: 'Heatwave', value: heatwaveWarningsEnabled ? 'On' : 'Off' });
    }

    if (!parts.length) {
      els.filterSummary.innerHTML = '<span class="small muted">No filters applied.</span>';
      return;
    }

    els.filterSummary.innerHTML = [
      '<span class="small muted">Filters:</span>',
      ...parts.map(p => `<span class="filter-chip"><b>${escapeHtml(p.label)}:</b> ${escapeHtml(p.value)}</span>`)
    ].join('');
  }

  function badgeFor(sev){
    if (sev === 'danger') {
      const tip = escapeHtml(DANGER_TOOLTIP);
      return `<span class="badge danger" data-tooltip="${tip}" aria-label="${tip}" tabindex="0">Very high</span>`;
    }
    if (sev === 'warning') {
      const tip = escapeHtml(WARNING_TOOLTIP);
      return `<span class="badge warning" data-tooltip="${tip}" aria-label="${tip}" tabindex="0">High</span>`;
    }
    return '';
  }

  function renderWeatherWarningButton(row){
    const warnings = warningsForRow(row);
    const ids = warnings.map(w => w?.id).filter(Boolean);
    if (!ids.length) return '';
    const count = ids.length;
    const label = `Weather alert${count > 1 ? 's' : ''} for ${row.name} (${count})`;
    const idsAttr = escapeHtml(ids.join(','));
    const nameAttr = escapeHtml(row.name || '');
    const stateAttr = escapeHtml(row.state || '');
    return `
      <button class="weather-warning-btn wx-alert" type="button" data-warning-ids="${idsAttr}" data-park-name="${nameAttr}" data-park-state="${stateAttr}" aria-label="${escapeHtml(label)}" aria-haspopup="dialog" aria-controls="warningModal" title="${escapeHtml(label)}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M10.29 3.86 1.82 18a1 1 0 0 0 .85 1.5h18.66a1 1 0 0 0 .85-1.5L13.71 3.86a1 1 0 0 0-1.72 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <span class="weather-warning-count">${count}</span>
      </button>
    `;
  }

  function renderTable(rows){
    const slots = ensureForecastSlots();
    if (!rows.length) {
      if (isLoading) {
        if (tableState !== 'loading') {
          els.tbody.innerHTML = `
            <tr class="loading-row">
              <td class="empty-cell" colspan="${TABLE_COL_COUNT}">
                <div class="loading-state" role="status" aria-live="polite">
                  <div class="spinner" aria-hidden="true"></div>
                  <div class="loading-title">Loading parks...</div>
                  <div class="small muted">Fetching the latest BOM data.</div>
                </div>
              </td>
            </tr>
          `;
          tableState = 'loading';
        }
        return;
      }
      if (!allRows.length) {
        if (tableState !== 'blank') {
          els.tbody.innerHTML = '';
          tableState = 'blank';
        }
        return;
      }

      if (tableState !== 'empty') {
        els.tbody.innerHTML = `
          <tr class="empty-row">
            <td class="empty-cell" colspan="${TABLE_COL_COUNT}">
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  <line x1="8" y1="8" x2="14" y2="14"></line>
                  <line x1="14" y1="8" x2="8" y2="14"></line>
                </svg>
                <div class="empty-title">No parks match the current filters.</div>
                <div class="small muted">Try adjusting the state, search, or alert filters.</div>
              </div>
            </td>
          </tr>
        `;
        tableState = 'empty';
      }
      return;
    }
    tableState = 'rows';
    const isAllMode = (els.stateFilter?.value === 'ALL');
    els.tbody.innerHTML = rows.map(r => {
      const badge = badgeFor(r.severity);
      const weatherWarningBtn = renderWeatherWarningButton(r);
      const updatedText = r.issueTime ? timeAgo(r.issueTime) : '—';
      const parkTz = isAllMode ? (timeZoneForState(r.state) || getDisplayTimeZone()) : null;

      const errorLine = r.error
        ? `<div class="muted">${escapeHtml(r.error)}</div>`
        : '';

      const stationLine = r.error
        ? ''
        : `<div class="small muted">Station: ${escapeHtml(r.stationName || '—')}</div>`;

      const updatedCol = r.error
        ? `<span class="muted">—</span>`
        : `<span class="small">${escapeHtml(updatedText)}</span>`;

      const currentVal = r.gustKmh;
      const currentInner = isAllMode
        ? (() => {
            const tip = escapeHtml(`Park time: ${formatHourLabelMs(Date.now(), parkTz)}`);
            return `<span class="cell-tooltip" data-tooltip="${tip}" aria-label="${tip}" tabindex="0">${formatKmh(currentVal)}</span>`;
          })()
        : formatKmh(currentVal);
      const hourCells = slots.map(slot => {
        const v = (r.hourlyGusts && typeof r.hourlyGusts.get === 'function')
          ? r.hourlyGusts.get(slot.ms)
          : null;
        const inner = isAllMode
          ? (() => {
              const tip = escapeHtml(`Park time: ${formatHourLabelMs(slot.ms, parkTz)}`);
              return `<span class="cell-tooltip" data-tooltip="${tip}" aria-label="${tip}" tabindex="0">${formatKmh(v)}</span>`;
            })()
          : formatKmh(v);
        return `<td class="right hour-cell ${cellClassFor(v)}">${inner}</td>`;
      }).join('');

      return `
        <tr>
          <td>
            <div class="row-top">
              <div class="park-name">
                <b>${escapeHtml(r.name)}</b>
                ${badge}
                ${weatherWarningBtn}
              </div>
            </div>
            ${errorLine}
            ${stationLine}
          </td>
          <td class="right current-col ${cellClassFor(currentVal)}">${currentInner}</td>
          ${hourCells}
          <td class="right updated-col">${updatedCol}</td>
        </tr>
      `;
    }).join('');
  }

  function render(){
    const rows = filteredRows();
    renderStats(rows);
    renderFilterSummary();
    updateHourHeaders();
    renderTable(rows);
    updateSortIndicators();
  }

  function resetFilters(){
    const prevState = els.stateFilter.value;
    els.stateFilter.value = DEFAULT_FILTERS.state;
    els.regionFilter.value = DEFAULT_FILTERS.region;
    els.textFilter.value = DEFAULT_FILTERS.text;
    severityFilter = DEFAULT_FILTERS.severity;
    showWeatherWarnings = DEFAULT_FILTERS.alertsOnly;
    heatwaveWarningsEnabled = DEFAULT_FILTERS.heatwaveWarnings;

    if (els.severityFilter) els.severityFilter.value = severityFilter;
    if (els.showWxWarnings) els.showWxWarnings.checked = !!showWeatherWarnings;
    if (els.showHeatwaveWarnings) els.showHeatwaveWarnings.checked = !!heatwaveWarningsEnabled;
    syncWeatherToggle();
    syncHeatwaveToggle();

    savePrefs();
    updateUrlFromFilters();

    const stateChanged = prevState !== els.stateFilter.value;
    if (stateChanged) {
      cache.locations.clear();
      allRows = [];
      render();
      loadData();
      return;
    }

    render();
  }

  let renderScheduled = false;
  const raf = (typeof requestAnimationFrame === 'function')
    ? requestAnimationFrame
    : (cb) => setTimeout(cb, 16);

  function scheduleRender(){
    if (renderScheduled) return;
    renderScheduled = true;
    raf(() => {
      renderScheduled = false;
      render();
    });
  }

  function timeAgo(ts){
    const t = new Date(ts).getTime();
    if (!Number.isFinite(t)) return '—';
    const now = Date.now();
    let s = Math.max(0, Math.floor((now - t) / 1000));

    if (s < 10) return 'just now';
    if (s < 60) return `${s}s ago`;

    const m = Math.floor(s / 60);
    if (m < 60) return `${m}m ago`;

    const h = Math.floor(m / 60);
    if (h < 48) return `${h}h ago`;

    const d = Math.floor(h / 24);
    if (d < 14) return `${d}d ago`;

    const w = Math.floor(d / 7);
    if (w < 8) return `${w}w ago`;

    const mo = Math.floor(d / 30);
    if (mo < 24) return `${mo}mo ago`;

    const y = Math.floor(d / 365);
    return `${y}y ago`;
  }

  function isProbablyHtml(text){
    const t = String(text || '').trimStart();
    if (!t) return false;
    if (t.startsWith('<')) return true;
    if (/<!doctype\s+html/i.test(t)) return true;
    if (/<html[\s>]/i.test(t)) return true;
    return false;
  }

  async function fetchJson(url){
    const proxied = `${PROXY_BASE.replace(/\/$/, '')}/fetch?url=${encodeURIComponent(url)}`;

    const res = await fetch(proxied, {
      method: 'GET',
      headers: { 'accept': 'application/json' },
      cache: 'no-store',
    });

    const bodyText = await res.text();

    if (isProbablyHtml(bodyText)) {
      const snippet = bodyText.replace(/\s+/g, ' ').slice(0, 180);
      throw new Error(`Upstream returned HTML (likely blocked). ${res.status} ${res.statusText}. Snippet: ${snippet}`);
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${bodyText.slice(0, 220)}`);
    }

    try {
      return JSON.parse(bodyText);
    } catch {
      throw new Error(`Non-JSON response (${bodyText.slice(0, 120)})`);
    }
  }

  async function bomWarningDetail(id){
    const url = `${BOM_BASE}/warnings/${encodeURIComponent(id)}`;
    const json = await fetchJson(url);
    if (json?.errors?.length) {
      const e = json.errors[0];
      throw new Error(`${e.title || 'BOM error'}: ${e.detail || e.code || 'unknown'}`);
    }
    return json;
  }

  function isImportantWarning(warn){
    if (isCancellationWarning(warn)) return false;
    const group = String(warn?.warning_group_type || '').toLowerCase();
    if (!group) return true;
    return IMPORTANT_WARNING_GROUPS.has(group);
  }

  function registerWarnings(list){
    const filtered = Array.isArray(list) ? list.filter(isImportantWarning) : [];
    filtered.forEach(w => {
      if (w && typeof w === 'object' && w.id) warningsById.set(w.id, w);
    });
    return filtered;
  }

  // Location-specific warnings are more reliable than title matching.
  async function bomLocationWarnings(geohash){
    const gh = String(geohash || '');
    const url = `${BOM_BASE}/locations/${encodeURIComponent(gh)}/warnings`;
    const json = await fetchJson(url);
    if (json?.errors?.length) {
      const e = json.errors[0];
      throw new Error(`${e.title || 'BOM error'}: ${e.detail || e.code || 'unknown'}`);
    }
    const list = Array.isArray(json?.data) ? json.data : [];
    return registerWarnings(list);
  }

  function getWarningDetail(id){
    if (!id) return Promise.resolve(null);
    const cached = warningDetailCache.get(id);
    if (cached) return cached;
    const promise = bomWarningDetail(id)
      .then(json => json?.data || null)
      .catch(() => null);
    warningDetailCache.set(id, promise);
    return promise;
  }

  async function bomSearchLocation(searchTerm, state){
    const key = `${searchTerm}|${state}`;
    const now = Date.now();
    const cached = cache.locations.get(key);
    if (cached) {
      if (cached.promise) return cached.promise;
      if (cached.expiresAt > now) return cached.value;
      cache.locations.delete(key);
    }

    const url = `${BOM_BASE}/locations?search=${encodeURIComponent(searchTerm)}`;
    const promise = (async () => {
      const json = await fetchJson(url);

      if (!json || !Array.isArray(json.data)) {
        throw new Error('BOM locations payload missing data[]');
      }

      const candidates = (json.data || []).filter(x => x?.state === state);
      const pick = candidates[0] || (json.data || [])[0] || null;

      cache.locations.set(key, { value: pick, expiresAt: Date.now() + LOC_CACHE_TTL_MS });
      return pick;
    })();

    cache.locations.set(key, { promise, expiresAt: now + LOC_CACHE_TTL_MS });
    promise.catch(() => {
      const curr = cache.locations.get(key);
      if (curr && curr.promise === promise) cache.locations.delete(key);
    });
    return promise;
  }

  async function bomObservations(geohash){
    // Observations commonly accept a 6-char geohash, but not always.
    // Send the full geohash and let the proxy try safe variants.
    const gh = String(geohash || '');
    const url = `${BOM_BASE}/locations/${encodeURIComponent(gh)}/observations`;
    const json = await fetchJson(url);

    if (json?.errors?.length) {
      const e = json.errors[0];
      throw new Error(`${e.title || 'BOM error'}: ${e.detail || e.code || 'unknown'}`);
    }

    return json;
  }

  // Hourly forecasts (broader coverage than 3-hourly)
  // We pass the location geohash and let the proxy try safe variants.
  async function bomForecastHourly(geohash){
    const gh = String(geohash || '');
    const url = `${BOM_BASE}/locations/${encodeURIComponent(gh)}/forecasts/hourly`;
    const json = await fetchJson(url);
    if (json?.errors?.length) {
      const e = json.errors[0];
      throw new Error(`${e.title || 'BOM error'}: ${e.detail || e.code || 'unknown'}`);
    }
    return json;
  }

  async function loadData(){
    const st = els.stateFilter.value;
    const parks = (st === 'ALL') ? PARKS : PARKS.filter(p => p.state === st);
    warningsById = new Map();
    warningDetailCache.clear();

    const tz = getDisplayTimeZone();
    const mode = getHourHeaderMode();
    forecastSlots = buildForecastSlots(Date.now(), tz, mode);
    forecastSlotsTz = tz;
    forecastSlotsMode = mode;
    updateHourHeaders();

    setRefreshing(true);
    isLoading = true;
    render();
    setStatus(`Loading ${parks.length} parks…`);

    const CONCURRENCY = 6;
    const queue = parks.map(p => ({...p}));
    const results = [];
    const weatherByGeohash = new Map();

    function getWeatherForGeohash(geohash){
      const gh = String(geohash || '');
      if (weatherByGeohash.has(gh)) return weatherByGeohash.get(gh);
      const promise = (async () => {
        const [obs, hourly, warnings] = await Promise.all([
          bomObservations(gh),
          bomForecastHourly(gh).catch(() => null),
          bomLocationWarnings(gh).catch(() => []),
        ]);
        return { obs, hourly, warnings };
      })();
      weatherByGeohash.set(gh, promise);
      promise.catch(() => {
        if (weatherByGeohash.get(gh) === promise) weatherByGeohash.delete(gh);
      });
      return promise;
    }

    async function worker(){
      while(queue.length){
        const p = queue.shift();
        const row = {
          ...p,
          loaded: false,
          gustKmh: null,
          hourlyGusts: new Map(),
          stationName: null,
          stationId: null,
          issueTime: null,
          severity: 'none',
          weatherWarnings: [],
          error: null,
        };

        try{
          const loc = await bomSearchLocation(p.searchTerm, p.state);
          if (!loc?.geohash) throw new Error('No BOM match');

          // Load current observations + hourly forecasts (best available gust forecast from BOM API)
          const { obs, hourly, warnings } = await getWeatherForGeohash(loc.geohash);

          const d = obs?.data || {};

          row.gustKmh = d?.gust?.speed_kilometre ?? null;
          row.stationName = d?.station?.name ?? null;
          row.stationId = d?.station?.bom_id ?? null;
          row.issueTime = obs?.metadata?.issue_time ?? obs?.metadata?.response_timestamp ?? null;
          row.weatherWarnings = Array.isArray(warnings) ? warnings : [];

          // Forecast picks (BOM hourly)
          // We map hourly items into a simple list: {time, gust}
          // Payload shape can vary, so we accept a couple of common structures.
          const hourlyRaw = hourly?.data;
          const hourlyItems = Array.isArray(hourlyRaw)
            ? hourlyRaw
            : Array.isArray(hourlyRaw?.forecasts)
              ? hourlyRaw.forecasts
              : Array.isArray(hourlyRaw?.hours)
                ? hourlyRaw.hours
                : null;

          if (Array.isArray(hourlyItems)) {
            const items = hourlyItems
              .map(it => {
                const time = it?.time ?? it?.valid_time ?? it?.date_time ?? null;

                // Gust: BOM hourly field names vary by feed/version.
                // Try a wide set of shapes so we can display gusts when they exist.
                const gust =
                  // Common shapes
                  it?.gust?.speed_kilometre ??
                  it?.wind_gust?.speed_kilometre ??
                  // Sometimes nested under wind
                  it?.wind?.gust?.speed_kilometre ??
                  it?.wind?.gust_speed_kilometre ??
                  it?.wind?.gust_speed_kmh ??
                  it?.wind?.gust_kilometre ??
                  it?.wind?.gust_kmh ??
                  // Flat field variants
                  it?.gust_speed_kilometre ??
                  it?.gust_speed_kmh ??
                  it?.gust_kilometre ??
                  it?.gust_kmh ??
                  null;

                return { time, gust };
              })
              .filter(it => it.time);

            const slots = ensureForecastSlots();
            const hourlyByHour = new Map();
            slots.forEach(slot => hourlyByHour.set(slot.ms, null));

            items.forEach(it => {
              const ms = Date.parse(it.time);
              if (!Number.isFinite(ms)) return;
              // Align by UTC hour boundary (BOM supplies UTC `...Z` timestamps).
              const hourMs = Math.floor(ms / HOUR_MS) * HOUR_MS;
              if (hourlyByHour.has(hourMs)) hourlyByHour.set(hourMs, it.gust);
            });

            row.hourlyGusts = hourlyByHour;
          }

          row.severity = rowLevel(row);
          row.loaded = true;
        } catch(e){
          row.loaded = true;
          row.error = (e && e.message) ? e.message : 'Failed to load';
          row.severity = 'none';
          row.weatherWarnings = [];
        }
        results.push(row);
        allRows = results;
        scheduleRender();

        // Pace requests (BOM edge protection can block bursts)
        await new Promise(r => setTimeout(r, 50));
      }
    }

    await Promise.all(Array.from({length: Math.min(CONCURRENCY, queue.length)}, worker));
    allRows = results;
    isLoading = false;
    render();
    raf(() => setRefreshing(false));

    const hadAnySuccess = results.some(r => {
      if (r.gustKmh != null) return true;
      if (r.hourlyGusts && typeof r.hourlyGusts.values === 'function') {
        for (const v of r.hourlyGusts.values()) {
          if (v != null && !Number.isNaN(v)) return true;
        }
      }
      return false;
    });
    if (!hadAnySuccess){
      setStatus('No data loaded. If this persists, BOM may be temporarily blocking requests. Try again in 1–2 minutes.');
    } else {
      // Success: clear status (we only show status when it adds value)
      setStatus('');
    }
  }

  function debounce(fn, ms){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  // --- Self-tests (lightweight) ---
  function assert(name, condition){
    if (!condition) throw new Error(`Self-test failed: ${name}`);
  }

  function runSelfTests(){
    // Preserve any user state (self-tests should be side-effect free)
    const prevSeverity = severityFilter;
    const prevWeather = showWeatherWarnings;
    const prevHeatwave = heatwaveWarningsEnabled;
    const prevState = els.stateFilter.value;
    const prevRegion = els.regionFilter.value;
    const prevText = els.textFilter.value;
    const prevRows = allRows;
    const prevSortKey = sortKey;
    const prevSortDir = sortDir;

    try {
      assert('threshold order', DANGER_KMH > WARNING_KMH);
      assert('level none', levelFor(null) === 'none');
      assert('level ok boundary', levelFor(WARNING_KMH - 0.1) === 'ok');
      assert('level warning', levelFor(WARNING_KMH) === 'warning');
      assert('level danger', levelFor(DANGER_KMH) === 'danger');

      // timeAgo sanity
      assert('timeAgo just now', timeAgo(new Date().toISOString()) === 'just now');

      // Timezone formatting sanity (guards the common 1-hour DST mismatch seen in NSW during summer)
      // 2026-01-22 is during DST in Australia/Sydney (AEDT = UTC+11).
      try {
        const ms = Date.parse('2026-01-22T01:00:00Z'); // should be 12pm in Sydney
        assert('formatHourLabelMs Sydney DST', formatHourLabelMs(ms, 'Australia/Sydney') === '12pm');
        const ms2 = Date.parse('2026-01-22T00:00:00Z'); // should be 10:30am in Adelaide (ACDT = UTC+10:30)
        assert('formatHourLabelMs Adelaide half-hour', formatHourLabelMs(ms2, 'Australia/Adelaide') === '10:30am');
      } catch {}

      allRows = [
        {state:'SA', name:'A', loaded:true, severity:'danger', gustKmh:70, hourlyGusts:new Map(), stationName:'X'},
        {state:'SA', name:'B', loaded:true, severity:'warning', gustKmh:55, hourlyGusts:new Map(), stationName:'Y'},
        {state:'SA', name:'C', loaded:true, severity:'ok', gustKmh:10, hourlyGusts:new Map(), stationName:null},
      ];
      els.stateFilter.value = 'SA';
      els.regionFilter.value = 'ALL';
      els.textFilter.value = '';

      severityFilter = 'all'; showWeatherWarnings = false;
      assert('filter off shows all', filteredRows().length === 3);

      const warnRow = { weatherWarnings: [{ type: 'heatwave warning' }, { type: 'flood' }] };
      heatwaveWarningsEnabled = true;
      assert('heatwave filter on', warningsForRow(warnRow).length === 2);
      heatwaveWarningsEnabled = false;
      assert('heatwave filter off', warningsForRow(warnRow).length === 1);
      heatwaveWarningsEnabled = prevHeatwave;

      assert('cancellation hidden', isImportantWarning({ title: 'Cancellation of Flood Warning' }) === false);

      severityFilter = 'warning';
      assert('warning includes danger', filteredRows().length === 2);

      severityFilter = 'danger';
      assert('danger only', filteredRows().length === 1);

      severityFilter = 'all';
      sortKey = 'gustKmh'; sortDir = 'desc';
      assert('sort numeric desc', filteredRows().map(r => r.name).join('') === 'ABC');

    } finally {
      severityFilter = prevSeverity;
      showWeatherWarnings = prevWeather;
      heatwaveWarningsEnabled = prevHeatwave;
      els.stateFilter.value = prevState;
      els.regionFilter.value = prevRegion;
      els.textFilter.value = prevText;
      allRows = prevRows;
      sortKey = prevSortKey;
      sortDir = prevSortDir;
    }
  }

  function renderWarningModal(parkName, state, warnings, details){
    const detailById = new Map();
    (details || []).forEach(d => { if (d?.id) detailById.set(d.id, d); });

    const tzNote = timeZoneForState(state) ? `${state} local time` : 'local time';
    const summaryParts = [
      `Alerts provided by BOM. Times shown in ${tzNote}.`,
      `Showing ${IMPORTANT_WARNING_LABEL}.`,
    ];
    if (!heatwaveWarningsEnabled) summaryParts.push('Heatwave alerts hidden by filter.');
    const summary = `<p class="small muted">${summaryParts.join(' ')}</p>`;

    const cards = (warnings || []).map(w => {
      const detail = detailById.get(w.id) || {};
      const shortTitle = detail.short_title || w.short_title || w.title || 'Weather alert';
      const areaTitle = detail.title || w.title || '';
      const group = String(w.warning_group_type || '').toLowerCase();
      const groupClass = group ? `group-${group.replace(/[^a-z0-9-]/g, '')}` : '';
      const typeLabel = formatWarningType(detail.type || w.type);
      const phase = detail.phase || w.phase || '';

      const chips = [];
      if (typeLabel) chips.push(`<span class="warning-chip type">${escapeHtml(typeLabel)}</span>`);
      if (group) chips.push(`<span class="warning-chip ${groupClass}">${escapeHtml(group)}</span>`);

      const issue = detail.issue_time || w.issue_time || '';
      const expiry = detail.expiry_time || w.expiry_time || '';
      const metaParts = [];
      if (issue) metaParts.push(`Issued ${formatDateTime(issue, state)}`);
      if (expiry) metaParts.push(`Expires ${formatDateTime(expiry, state)}`);
      if (phase) metaParts.push(`Status: ${phase}`);
      const metaHtml = metaParts.length
        ? metaParts.map(m => `<span>${escapeHtml(m)}</span>`).join('')
        : '<span>Timing details not available.</span>';

      const messageHtml = detail.message ? sanitizeWarningHtml(detail.message) : '';
      const messageBlock = messageHtml
        ? `<div class="warning-message">${messageHtml}</div>`
        : `<div class="warning-message muted">No detailed message is available for this alert.</div>`;

      return `
        <article class="warning-card">
          <div class="warning-card-head">
            <div>
              <div class="warning-card-title">${escapeHtml(shortTitle)}</div>
              ${areaTitle ? `<div class="warning-card-area">${escapeHtml(areaTitle)}</div>` : ''}
            </div>
            <div class="warning-chip-row">${chips.join('')}</div>
          </div>
          <details class="warning-details">
            <summary>Show details</summary>
            <div class="warning-meta">${metaHtml}</div>
            ${messageBlock}
          </details>
        </article>
      `;
    }).join('');

    els.warningBody.innerHTML = `
      ${summary}
      <div class="warning-list">
        ${cards || '<div class="empty-state"><div class="empty-title">No active alerts for this park.</div><div class="small muted">Alerts are refreshed with the BOM feed.</div></div>'}
      </div>
    `;

    if (els.warningTitle) {
      els.warningTitle.textContent = `Weather alerts for ${parkName}`;
    }
  }

  function openWarningModal(parkName, state, warningIds){
    const ids = Array.isArray(warningIds) ? warningIds : [];
    if (!ids.length) return;

    warningModalToken += 1;
    const token = warningModalToken;
    const warnings = ids.map(id => warningsById.get(id)).filter(Boolean);

    if (els.warningTitle) {
      els.warningTitle.textContent = `Weather alerts for ${parkName}`;
    }
    els.warningBody.innerHTML = `
      <div class="loading-state" role="status" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loading-title">Loading alerts...</div>
        <div class="small muted">Fetching details from BOM.</div>
      </div>
    `;
    els.warningModal.classList.add('open');

    Promise.all(warnings.map(w => getWarningDetail(w.id))).then(details => {
      if (token !== warningModalToken) return;
      renderWarningModal(parkName, state, warnings, details);
    });
  }

  function closeWarningModal(){ els.warningModal.classList.remove('open'); }

  // Events
  function openInfo(){ els.infoModal.classList.add('open'); }
  function closeInfo(){ els.infoModal.classList.remove('open'); }

  els.infoBtn.addEventListener('click', openInfo);
  els.infoClose.addEventListener('click', closeInfo);
  els.infoModal.addEventListener('click', (e) => {
    if (e.target && e.target.dataset && e.target.dataset.close) closeInfo();
  });
  els.warningClose.addEventListener('click', closeWarningModal);
  els.warningModal.addEventListener('click', (e) => {
    if (e.target && e.target.dataset && e.target.dataset.close) closeWarningModal();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (els.infoModal.classList.contains('open')) closeInfo();
    if (els.warningModal.classList.contains('open')) closeWarningModal();
  });

  if (els.darkModeToggle) {
    els.darkModeToggle.addEventListener('change', (e) => {
      darkModeEnabled = !!e.target.checked;
      applyTheme();
      savePrefs();
    });
  }

  // Sortable headers (event delegation). Updated column is excluded.
  document.querySelector('thead').addEventListener('click', (e) => {
    const th = e.target.closest('th[data-key]');
    if (!th) return;
    setSort(th.dataset.key);
  });

  // Weather alert icons live in the table body (event delegation).
  els.tbody.addEventListener('click', (e) => {
    const btn = e.target.closest('.weather-warning-btn');
    if (!btn) return;
    const ids = String(btn.dataset.warningIds || '')
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);
    if (!ids.length) return;
    openWarningModal(btn.dataset.parkName || 'Park', btn.dataset.parkState || '', ids);
  });

  if (els.severityFilter) {
    els.severityFilter.addEventListener('change', () => {
      const val = String(els.severityFilter.value || '').toLowerCase();
      severityFilter = (val === 'warning' || val === 'danger') ? val : 'all';
      savePrefs();
      updateUrlFromFilters();
      render();
    });
  }

  if (els.showWxWarnings) {
    els.showWxWarnings.addEventListener('change', (e) => {
      showWeatherWarnings = !!e.target.checked;
      syncWeatherToggle();
      savePrefs();
      updateUrlFromFilters();
      render();
    });
  }

  if (els.showHeatwaveWarnings) {
    els.showHeatwaveWarnings.addEventListener('change', (e) => {
      heatwaveWarningsEnabled = !!e.target.checked;
      syncHeatwaveToggle();
      savePrefs();
      updateUrlFromFilters();
      render();
    });
  }

  if (els.resetFiltersBtn) {
    els.resetFiltersBtn.addEventListener('click', resetFilters);
  }

  els.stateFilter.addEventListener('change', () => {
    savePrefs();
    updateUrlFromFilters();
    cache.locations.clear();
    allRows = [];
    render();
    loadData();
  });

  els.regionFilter.addEventListener('change', () => {
    savePrefs();
    updateUrlFromFilters();
    render();
  });

  els.textFilter.addEventListener('input', () => {
    savePrefsDebounced();
    updateUrlDebounced();
    renderDebounced();
  });

  els.refreshBtn.addEventListener('click', () => {
    // Refresh keeps filters/sort as-is.
    savePrefs();
    updateUrlFromFilters();
    cache.locations.clear();
    allRows = [];
    render();
    loadData();
  });

  // Initial
  try {
    const wEl = document.getElementById('warningValue');
    const dEl = document.getElementById('dangerValue');
    if (wEl) wEl.textContent = String(WARNING_KMH);
    if (dEl) dEl.textContent = String(DANGER_KMH);

    applyPrefs();
    applyUrlFilters();
    syncWeatherToggle();
    syncHeatwaveToggle();
    applyTheme();
    runSelfTests();
    render();
    loadData();
  } catch (e) {
    setStatus((e && e.message) ? e.message : 'Startup error');
  }
</script>
</body>
</html>
